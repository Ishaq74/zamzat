---
import Layout from '@layouts/Layout.astro';
import { supabase } from "../lib/supabase";

const accessToken = Astro.cookies.get("sb-access-token");
const refreshToken = Astro.cookies.get("sb-refresh-token");

if (!accessToken || !refreshToken) {
  return Astro.redirect("/signin");
}

let session;
try {
  session = await supabase.auth.setSession({
    refresh_token: refreshToken.value,
    access_token: accessToken.value,
  });
  if (session.error) {
    Astro.cookies.delete("sb-access-token", { path: "/" });
    Astro.cookies.delete("sb-refresh-token", { path: "/" });
    return Astro.redirect("/signin");
  }
} catch (error) {
  Astro.cookies.delete("sb-access-token", { path: "/" });
  Astro.cookies.delete("sb-refresh-token", { path: "/" });
  return Astro.redirect("/signin");
}

const user = session.data.user;
const profileImage = user.user_metadata?.avatar_url || '/images/default-avatar.png';
const username = user.user_metadata?.full_name || user.email.split("@")[0] || "Anne Honyme";
const bio = Users.bio || "";
---

<Layout title="Mon Profil" description="Page de profil utilisateur.">
  <section class="flex flex-col items-center py-10">
    <h1 class="text-3xl font-bold">Mon Profil</h1>
    <div class="bg-white p-6 rounded-lg shadow-lg w-full max-w-md">
      <div class="flex flex-col items-center">
        <img id="profile-pic" src={profileImage} alt="Avatar" class="w-32 h-32 rounded-full border object-cover" />
        <input type="file" id="avatar-upload" class="hidden" accept="image/png, image/jpeg, image/webp, image/heic" />
        <button id="upload-btn" class="mt-2 px-4 py-2 bg-blue-500 text-white rounded-md">Changer la photo</button>
        <p id="upload-error" class="text-red-500 mt-2 text-sm hidden"></p>
      </div>
      <div class="mt-4">
        <label class="block text-gray-700">Nom d'utilisateur</label>
        <input type="text" id="username" value={username} class="w-full p-2 border rounded-md" />
      </div>
      <div class="mt-4">
        <label class="block text-gray-700">Bio</label>
        <textarea id="bio" class="w-full p-2 border rounded-md">{bio}</textarea>
      </div>
      <button id="save-btn" class="mt-4 w-full px-4 py-2 bg-green-500 text-white rounded-md">Enregistrer</button>
      <div id="response-msg" class="mt-4 hidden">
        <p id="success-msg" class="text-green-500 hidden">Profil mis à jour avec succès !</p>
        <p id="error-msg" class="text-red-500 hidden">Erreur lors de la mise à jour.</p>
      </div>
    </div>
  </section>
  <script>
    document.getElementById("upload-btn").addEventListener("click", () => {
      document.getElementById("avatar-upload").click();
    });
    document.getElementById("avatar-upload").addEventListener("change", async (event) => {
      const file = event.target.files[0];
      if (!file || file.size > 2 * 1024 * 1024) {
        document.getElementById("upload-error").textContent = "Fichier trop volumineux (max 2MB).";
        document.getElementById("upload-error").classList.remove("hidden");
        return;
      }
      const formData = new FormData();
      formData.append("avatar", file);
      const response = await fetch("/api/user/update", { method: "POST", body: formData });
      const data = await response.json();
      if (data.url) {
        document.getElementById("profile-pic").src = data.url;
      }
    });
    document.getElementById("save-btn").addEventListener("click", async () => {
      const username = document.getElementById("username").value;
      const bio = document.getElementById("bio").value;
      const response = await fetch("/api/user/update", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ username, bio })
      });
      const data = await response.json();
      document.getElementById("response-msg").classList.remove("hidden");
      if (data.success) {
        document.getElementById("success-msg").classList.remove("hidden");
        document.getElementById("error-msg").classList.add("hidden");
      } else {
        document.getElementById("success-msg").classList.add("hidden");
        document.getElementById("error-msg").classList.remove("hidden");
      }
    });
  </script>
</Layout>